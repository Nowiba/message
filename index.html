<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Reminder System</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .card {
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="datetime-local"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 5px;
        }

        button:hover {
            background-color: #3367d6;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .appointments-list {
            margin-top: 30px;
        }

        .appointment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appointment-item:last-child {
            border-bottom: none;
        }

        .notification-permission {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            color: var(--error-color);
            margin-top: 5px;
            font-size: 14px;
            display: none;
        }

        .success-message {
            color: var(--secondary-color);
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .browser-warning {
            background-color: #ffebee;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: var(--secondary-color);
        }

        .status-disconnected {
            background-color: var(--error-color);
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
</head>
<body>
    <div class="container">
        <h1>Appointment Reminder System</h1>
        
        <div class="browser-warning" id="browserWarning">
            <h3>Browser Compatibility Notice</h3>
            <p>For best experience, use Chrome, Firefox, or Safari. Brave users may need to:</p>
            <ol>
                <li>Click the lock icon in the address bar</li>
                <li>Select "Site settings"</li>
                <li>Change notifications to "Allow"</li>
            </ol>
        </div>
        
        <div class="notification-permission" id="notificationPermission">
            <p>Notifications are required for appointment reminders.</p>
            <button id="enableNotificationsBtn">Enable Notifications</button>
            <p id="tokenStatus"><span class="status-indicator status-disconnected"></span> Notifications not enabled</p>
        </div>

        <div class="card">
            <h2>Schedule New Appointment</h2>
            <form id="appointmentForm">
                <div class="form-group">
                    <label for="appointmentTitle">Title (Optional)</label>
                    <input type="text" id="appointmentTitle" placeholder="Dentist, Meeting, etc.">
                </div>
                <div class="form-group">
                    <label for="appointmentTime">Date & Time</label>
                    <input type="datetime-local" id="appointmentTime" required>
                    <div class="error-message" id="timeError">Please select a future date and time</div>
                </div>
                <button type="submit" id="submitBtn">Schedule Appointment</button>
            </form>
            <div class="success-message" id="successMessage">
                Appointment scheduled successfully! You'll receive a notification 30 minutes before.
            </div>
        </div>

        <div class="card appointments-list">
            <h2>Your Appointments</h2>
            <div id="appointmentsContainer">
                <p id="noAppointments">No appointments scheduled yet.</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMJuAmIAqDUXhZcGBHq8CszhJL92VaZ64",
            authDomain: "information-project1.firebaseapp.com",
            databaseURL: "https://information-project1-default-rtdb.firebaseio.com",
            projectId: "information-project1",
            storageBucket: "information-project1.firebasestorage.app",
            messagingSenderId: "1098270976013",
            appId: "1:1098270976013:web:2e1ca7602b316b6ed30d44",
            measurementId: "G-YFL07VDXCX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let messaging;

        // DOM Elements
        const appointmentForm = document.getElementById('appointmentForm');
        const appointmentTime = document.getElementById('appointmentTime');
        const appointmentTitle = document.getElementById('appointmentTitle');
        const submitBtn = document.getElementById('submitBtn');
        const timeError = document.getElementById('timeError');
        const successMessage = document.getElementById('successMessage');
        const notificationPermission = document.getElementById('notificationPermission');
        const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');
        const appointmentsContainer = document.getElementById('appointmentsContainer');
        const noAppointments = document.getElementById('noAppointments');
        const tokenStatus = document.getElementById('tokenStatus');
        const browserWarning = document.getElementById('browserWarning');

        // Set minimum datetime to current time
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
        appointmentTime.min = localISOTime;

        // Global variables
        let fcmToken = null;
        let isBrave = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            detectBrowser();
            setupEventListeners();
            checkNotificationPermission();
            loadAppointments();
        });

        // Detect browser type
        function detectBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            isBrave = userAgent.includes('brave');
            
            // Show warning for Brave and Safari
            if (isBrave || navigator.userAgent.includes('safari') && !navigator.userAgent.includes('chrome')) {
                browserWarning.style.display = 'block';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            appointmentForm.addEventListener('submit', scheduleAppointment);
            enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
        }

        // Register service worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js');
                    console.log('Service Worker registered');
                    
                    // Initialize messaging after service worker is registered
                    initializeMessaging();
                    return true;
                } catch (err) {
                    console.error('Service Worker registration failed:', err);
                    return false;
                }
            }
            return false;
        }

        // Initialize Firebase Messaging
        function initializeMessaging() {
            try {
                messaging = firebase.messaging();
                
                // Handle incoming messages
                messaging.onMessage((payload) => {
                    console.log('Message received in foreground', payload);
                    showNotification(payload.notification.title, payload.notification.body);
                });
                
                return true;
            } catch (error) {
                console.error('Error initializing messaging:', error);
                return false;
            }
        }

        // Show notification
        function showNotification(title, body) {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: '/icons/icon-192x192.png'
                });
            }
        }

        // Check notification permission status
        async function checkNotificationPermission() {
            try {
                if (Notification.permission === 'denied') {
                    notificationPermission.style.display = 'block';
                    tokenStatus.innerHTML = '<span class="status-indicator status-disconnected"></span> Notifications blocked';
                    return false;
                }
                
                if (Notification.permission === 'granted') {
                    notificationPermission.style.display = 'none';
                    return await getFCMToken();
                }
                
                // Handle cases where permission is 'default' but notifications might work
                const token = await getFCMToken();
                if (token) {
                    notificationPermission.style.display = 'none';
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Permission check failed:', error);
                return false;
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    // Register service worker after permission is granted
                    const swRegistered = await registerServiceWorker();
                    
                    if (swRegistered) {
                        const token = await getFCMToken();
                        if (token) {
                            notificationPermission.style.display = 'none';
                            tokenStatus.innerHTML = '<span class="status-indicator status-connected"></span> Notifications enabled';
                            return true;
                        }
                    }
                }
                
                // If we get here, something failed
                tokenStatus.innerHTML = '<span class="status-indicator status-disconnected"></span> Failed to enable notifications';
                return false;
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                tokenStatus.innerHTML = '<span class="status-indicator status-disconnected"></span> Error enabling notifications';
                return false;
            }
        }

        // Get FCM token
        async function getFCMToken() {
            try {
                if (!messaging) {
                    if (!initializeMessaging()) {
                        throw new Error('Messaging not initialized');
                    }
                }

                const token = await messaging.getToken();
                if (!token) {
                    throw new Error('No token received');
                }

                console.log('FCM Token:', token);
                fcmToken = token;
                tokenStatus.innerHTML = '<span class="status-indicator status-connected"></span> Notifications enabled';
                return token;
            } catch (error) {
                console.error('FCM Token Error:', error);
                notificationPermission.style.display = 'block';
                tokenStatus.innerHTML = '<span class="status-indicator status-disconnected"></span> Failed to get token';
                
                // Special handling for Brave
                if (isBrave) {
                    tokenStatus.innerHTML += '<br>Brave users: Check site permissions';
                }
                
                return null;
            }
        }

        // Schedule new appointment
        async function scheduleAppointment(e) {
            e.preventDefault();
            
            // Validate time
            const selectedTime = new Date(appointmentTime.value);
            if (selectedTime <= now) {
                timeError.style.display = 'block';
                return;
            }
            timeError.style.display = 'none';
            
            // Ensure we have a token
            if (!fcmToken) {
                const tokenResult = await requestNotificationPermission();
                if (!tokenResult) {
                    alert('Please enable notifications to schedule reminders');
                    return;
                }
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Scheduling...';

            try {
                const title = appointmentTitle.value.trim() || 'Appointment';
                const appointmentRef = database.ref('appointments').push();
                
                await appointmentRef.set({
                    title: title,
                    timestamp: selectedTime.toISOString(),
                    fcmToken: fcmToken,
                    reminderSent: false
                });
                
                // Show success and reset form
                successMessage.style.display = 'block';
                appointmentForm.reset();
                setTimeout(() => successMessage.style.display = 'none', 3000);
                
                // Reload appointments
                loadAppointments();
            } catch (error) {
                console.error('Error scheduling appointment:', error);
                alert('Failed to schedule appointment. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Schedule Appointment';
            }
        }

        // Load appointments from Firebase
        function loadAppointments() {
            if (!fcmToken) return;
            
            database.ref('appointments').orderByChild('timestamp').on('value', (snapshot) => {
                const appointments = [];
                snapshot.forEach((childSnapshot) => {
                    const appointment = childSnapshot.val();
                    if (appointment.fcmToken === fcmToken) {
                        appointments.push({
                            id: childSnapshot.key,
                            ...appointment
                        });
                    }
                });
                
                renderAppointments(appointments);
            });
        }

        // Render appointments list
        function renderAppointments(appointments) {
            if (appointments.length === 0) {
                noAppointments.style.display = 'block';
                appointmentsContainer.innerHTML = '';
                return;
            }
            
            noAppointments.style.display = 'none';
            
            // Sort by date (soonest first)
            appointments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let html = '';
            appointments.forEach(appointment => {
                const date = new Date(appointment.timestamp);
                const formattedDate = date.toLocaleString();
                
                html += `
                    <div class="appointment-item">
                        <div>
                            <strong>${appointment.title}</strong>
                            <div>${formattedDate}</div>
                        </div>
                        <button class="delete-btn" data-id="${appointment.id}">Delete</button>
                    </div>
                `;
            });
            
            appointmentsContainer.innerHTML = html;
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', deleteAppointment);
            });
        }

        // Delete appointment
        async function deleteAppointment(e) {
            const appointmentId = e.target.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this appointment?')) {
                try {
                    await database.ref(`appointments/${appointmentId}`).remove();
                } catch (error) {
                    console.error('Error deleting appointment:', error);
                    alert('Failed to delete appointment. Please try again.');
                }
            }
        }
    </script>
</body>
</html>
